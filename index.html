<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trail Mapper Pro - GPS & Trail Analysis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .upload-section {
            padding: 30px;
            background: #f7f9fc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-label {
            display: block;
            padding: 20px;
            background: white;
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .file-input-label:hover {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .file-input-label.has-file {
            border-color: #48bb78;
            background: #f0fdf4;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 0;
        }
        
        .map-section {
            position: relative;
        }
        
        #map {
            height: 600px;
            background: #f0f0f0;
        }
        
        .side-panel {
            background: #f7f9fc;
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .panel-section {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .panel-section h3 {
            font-size: 1.1em;
            color: #2d3748;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .stats-compact {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .stat-item {
            background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
            padding: 10px;
            border-radius: 8px;
        }
        
        .stat-label {
            font-size: 0.75em;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3748;
        }
        
        .trail-info {
            background: #e6fffa;
            border-left: 4px solid #10b981;
            padding: 12px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .trail-info h4 {
            color: #065f46;
            margin-bottom: 8px;
        }
        
        .trail-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .badge-difficulty {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-surface {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .badge-type {
            background: #ede9fe;
            color: #5b21b6;
        }
        
        .chart-container {
            padding: 30px;
            background: #f7f9fc;
        }
        
        .chart-wrapper {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #elevationChart {
            max-height: 300px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: white;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            font-size: 0.9em;
            color: #4a5568;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-unit {
            font-size: 0.8em;
            color: #718096;
            margin-left: 5px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #718096;
        }
        
        .layer-info {
            background: #f0fdf4;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #065f46;
        }
        
        .match-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .match-percentage {
            font-size: 1.5em;
            font-weight: bold;
            color: #92400e;
        }
        
        .trail-search-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .trail-item {
            padding: 8px;
            background: white;
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .trail-item:hover {
            background: #f0fdf4;
        }
        
        .trail-item-name {
            font-weight: 600;
            color: #2d3748;
        }
        
        .trail-item-details {
            font-size: 0.85em;
            color: #718096;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .side-panel {
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó∫Ô∏è Trail Mapper Pro</h1>
            <p>Advanced GPS trail analysis with OpenTrailMap integration</p>
        </div>
        
        <div class="upload-section">
            <div class="file-input-wrapper">
                <input type="file" id="csvFile" accept=".csv">
                <label for="csvFile" class="file-input-label" id="fileLabel">
                    <strong>Choose CSV file</strong> or drag it here<br>
                    <small>Format: Latitude, Longitude, Elevation</small>
                </label>
            </div>
        </div>
        
        <div id="results" class="hidden">
            <div class="main-content">
                <div class="map-section">
                    <div id="map"></div>
                </div>
                
                <div class="side-panel">
                    <!-- Layer Control Info -->
                    <div class="layer-info">
                        üí° Use the layer control (top-right) to switch between map styles and overlays
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="panel-section">
                        <h3>üìä Track Statistics</h3>
                        <div class="stats-compact">
                            <div class="stat-item">
                                <div class="stat-label">Distance</div>
                                <div class="stat-value"><span id="quickDistance">0</span> mi</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Elevation Gain</div>
                                <div class="stat-value"><span id="quickElevGain">0</span> ft</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Max Elevation</div>
                                <div class="stat-value"><span id="quickMaxElev">0</span> ft</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Avg Grade</div>
                                <div class="stat-value"><span id="avgGrade">0</span>%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trail Match Section -->
                    <div class="panel-section">
                        <h3>üéØ Trail Match Analysis</h3>
                        <div id="trailMatchContent">
                            <div class="loading">Analyzing trail data...</div>
                        </div>
                    </div>
                    
                    <!-- Nearby Trails -->
                    <div class="panel-section">
                        <h3>ü•æ Nearby Trails</h3>
                        <div id="nearbyTrails">
                            <div class="loading">Searching for trails...</div>
                        </div>
                    </div>
                    
                    <!-- Trail Conditions -->
                    <div class="panel-section">
                        <h3>üå§Ô∏è Trail Conditions</h3>
                        <div id="trailConditions">
                            <p style="color: #718096; font-size: 0.9em;">Upload a track to see trail conditions</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Detailed Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Distance</h3>
                    <div class="stat-value">
                        <span id="totalDistance">0</span>
                        <span class="stat-unit">mi</span>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>Elevation Gain</h3>
                    <div class="stat-value">
                        <span id="elevationGain">0</span>
                        <span class="stat-unit">ft</span>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>Elevation Loss</h3>
                    <div class="stat-value">
                        <span id="elevationLoss">0</span>
                        <span class="stat-unit">ft</span>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>Net Elevation</h3>
                    <div class="stat-value">
                        <span id="netElevation">0</span>
                        <span class="stat-unit">ft</span>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>Max Elevation</h3>
                    <div class="stat-value">
                        <span id="maxElevation">0</span>
                        <span class="stat-unit">ft</span>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>Min Elevation</h3>
                    <div class="stat-value">
                        <span id="minElevation">0</span>
                        <span class="stat-unit">ft</span>
                    </div>
                </div>
            </div>
            
            <!-- Elevation Chart -->
            <div class="chart-container">
                <div class="chart-wrapper">
                    <canvas id="elevationChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let map = null;
        let userTrackPolyline = null;
        let matchedTrailPolyline = null;
        let elevationChart = null;
        let nearbyTrailsLayer = null;
        let currentCoordinates = [];
        let currentElevations = [];
        
        // Map layer configurations
        const MAP_LAYERS = {
            osm: {
                name: 'OpenStreetMap',
                layer: () => L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 18
                })
            },
            osmTopo: {
                name: 'OpenTopoMap',
                layer: () => L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenTopoMap contributors',
                    maxZoom: 17
                })
            },
            esriSatellite: {
                name: 'Satellite',
                layer: () => L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '¬© Esri',
                    maxZoom: 18
                })
            },
            cartoDB: {
                name: 'CartoDB Light',
                layer: () => L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                    attribution: '¬© CartoDB',
                    maxZoom: 18
                })
            },
            stamen: {
                name: 'Terrain',
                layer: () => L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_terrain/{z}/{x}/{y}.png', {
                    attribution: '¬© Stadia Maps, ¬© Stamen Design',
                    maxZoom: 18
                })
            }
        };
        
        const OVERLAY_LAYERS = {
            waymarkedHiking: {
                name: 'Hiking Trails',
                layer: () => L.tileLayer('https://tile.waymarkedtrails.org/hiking/{z}/{x}/{y}.png', {
                    attribution: '¬© Waymarked Trails',
                    maxZoom: 17,
                    opacity: 0.7
                })
            },
            waymarkedCycling: {
                name: 'Cycling Routes',
                layer: () => L.tileLayer('https://tile.waymarkedtrails.org/cycling/{z}/{x}/{y}.png', {
                    attribution: '¬© Waymarked Trails',
                    maxZoom: 17,
                    opacity: 0.7
                })
            },
            waymarkedMTB: {
                name: 'MTB Trails',
                layer: () => L.tileLayer('https://tile.waymarkedtrails.org/mtb/{z}/{x}/{y}.png', {
                    attribution: '¬© Waymarked Trails',
                    maxZoom: 17,
                    opacity: 0.7
                })
            }
        };
        
        // Haversine formula to calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959; // Radius of Earth in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Query Overpass API for nearby trails
        async function queryNearbyTrails(coordinates) {
            const bounds = getBounds(coordinates);
            const query = `
                [out:json][timeout:25];
                (
                  way["highway"~"path|footway|track|trail"]["name"]
                    (${bounds.south},${bounds.west},${bounds.north},${bounds.east});
                  way["route"~"hiking|foot|mtb|bicycle"]["name"]
                    (${bounds.south},${bounds.west},${bounds.north},${bounds.east});
                  relation["route"~"hiking|foot|mtb|bicycle"]["name"]
                    (${bounds.south},${bounds.west},${bounds.north},${bounds.east});
                );
                out body;
                >;
                out skel qt;
            `;
            
            try {
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });
                const data = await response.json();
                return processOverpassData(data);
            } catch (error) {
                console.error('Error querying Overpass API:', error);
                return [];
            }
        }
        
        function getBounds(coordinates) {
            let minLat = 90, maxLat = -90, minLon = 180, maxLon = -180;
            coordinates.forEach(coord => {
                minLat = Math.min(minLat, coord[0]);
                maxLat = Math.max(maxLat, coord[0]);
                minLon = Math.min(minLon, coord[1]);
                maxLon = Math.max(maxLon, coord[1]);
            });
            // Add padding
            const padding = 0.01; // roughly 1km
            return {
                north: maxLat + padding,
                south: minLat - padding,
                east: maxLon + padding,
                west: minLon - padding
            };
        }
        
        function processOverpassData(data) {
            const trails = [];
            const nodes = {};
            
            // First, store all nodes
            data.elements.forEach(element => {
                if (element.type === 'node') {
                    nodes[element.id] = element;
                }
            });
            
            // Process ways and relations
            data.elements.forEach(element => {
                if (element.type === 'way' && element.tags && element.tags.name) {
                    const trail = {
                        id: element.id,
                        name: element.tags.name,
                        type: element.tags.highway || element.tags.route || 'trail',
                        surface: element.tags.surface || 'unknown',
                        difficulty: element.tags['sac_scale'] || element.tags['mtb:scale'] || 'unknown',
                        access: element.tags.access || 'yes',
                        coordinates: []
                    };
                    
                    // Build coordinates from nodes
                    if (element.nodes) {
                        element.nodes.forEach(nodeId => {
                            if (nodes[nodeId]) {
                                trail.coordinates.push([nodes[nodeId].lat, nodes[nodeId].lon]);
                            }
                        });
                    }
                    
                    if (trail.coordinates.length > 0) {
                        trails.push(trail);
                    }
                }
            });
            
            return trails;
        }
        
        // Match uploaded track to nearby trails
        function findBestTrailMatch(userCoords, trails) {
            let bestMatch = null;
            let bestScore = 0;
            
            trails.forEach(trail => {
                if (trail.coordinates.length === 0) return;
                
                let matchedPoints = 0;
                const threshold = 0.0005; // roughly 50 meters
                
                userCoords.forEach(userCoord => {
                    trail.coordinates.forEach(trailCoord => {
                        const dist = Math.sqrt(
                            Math.pow(userCoord[0] - trailCoord[0], 2) + 
                            Math.pow(userCoord[1] - trailCoord[1], 2)
                        );
                        if (dist < threshold) {
                            matchedPoints++;
                            return;
                        }
                    });
                });
                
                const score = matchedPoints / userCoords.length;
                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = trail;
                }
            });
            
            return { trail: bestMatch, score: bestScore };
        }
        
        // Display trail match information
        function displayTrailMatch(match) {
            const container = document.getElementById('trailMatchContent');
            
            if (!match || !match.trail || match.score < 0.1) {
                container.innerHTML = `
                    <p style="color: #718096; font-size: 0.9em;">
                        No matching trails found in OpenStreetMap database.
                        This might be an unmapped trail!
                    </p>
                    <button onclick="suggestTrailMapping()" style="margin-top: 10px; padding: 5px 10px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Contribute to OpenStreetMap
                    </button>
                `;
                return;
            }
            
            const percentage = Math.round(match.score * 100);
            const trail = match.trail;
            
            container.innerHTML = `
                <div class="match-indicator">
                    <div class="match-percentage">${percentage}%</div>
                    <div>
                        <strong>Match Confidence</strong><br>
                        <small>Based on GPS overlap</small>
                    </div>
                </div>
                
                <div class="trail-info">
                    <h4>${trail.name}</h4>
                    <div class="trail-badges">
                        ${trail.difficulty !== 'unknown' ? `<span class="badge badge-difficulty">${trail.difficulty}</span>` : ''}
                        ${trail.surface !== 'unknown' ? `<span class="badge badge-surface">${trail.surface}</span>` : ''}
                        <span class="badge badge-type">${trail.type}</span>
                    </div>
                </div>
            `;
            
            // Add matched trail to map if good match
            if (percentage > 30 && trail.coordinates.length > 0) {
                if (matchedTrailPolyline) {
                    map.removeLayer(matchedTrailPolyline);
                }
                
                matchedTrailPolyline = L.polyline(trail.coordinates, {
                    color: '#3b82f6',
                    weight: 3,
                    opacity: 0.6,
                    dashArray: '10, 5'
                }).addTo(map);
                
                matchedTrailPolyline.bindPopup(`<strong>${trail.name}</strong><br>Official trail route`);
            }
        }
        
        // Display nearby trails
        function displayNearbyTrails(trails) {
            const container = document.getElementById('nearbyTrails');
            
            if (trails.length === 0) {
                container.innerHTML = '<p style="color: #718096; font-size: 0.9em;">No trails found in this area</p>';
                return;
            }
            
            const trailsHtml = trails.slice(0, 5).map(trail => `
                <div class="trail-item" onclick="highlightTrail('${trail.id}')">
                    <div class="trail-item-name">${trail.name}</div>
                    <div class="trail-item-details">
                        ${trail.type} ¬∑ ${trail.surface !== 'unknown' ? trail.surface : 'Surface unknown'}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = `
                <div class="trail-search-results">
                    ${trailsHtml}
                </div>
                <small style="color: #718096;">Found ${trails.length} trails nearby</small>
            `;
        }
        
        function suggestTrailMapping() {
            window.open('https://www.openstreetmap.org/edit', '_blank');
        }
        
        function highlightTrail(trailId) {
            console.log('Highlighting trail:', trailId);
        }
        
        function initializeMap(coordinates) {
            const mapContainer = document.getElementById('map');
            mapContainer.style.display = 'block';
            
            if (!map) {
                try {
                    // Initialize map
                    map = L.map('map', {
                        center: coordinates[0],
                        zoom: 13,
                        maxZoom: 18,
                        minZoom: 3
                    });
                    
                    // Create base layers
                    const baseLayers = {};
                    Object.entries(MAP_LAYERS).forEach(([key, config]) => {
                        baseLayers[config.name] = config.layer();
                    });
                    
                    // Create overlay layers
                    const overlayLayers = {};
                    Object.entries(OVERLAY_LAYERS).forEach(([key, config]) => {
                        overlayLayers[config.name] = config.layer();
                    });
                    
                    // Add default layer
                    baseLayers['OpenTopoMap'].addTo(map);
                    
                    // Add layer control
                    L.control.layers(baseLayers, overlayLayers, {
                        position: 'topright'
                    }).addTo(map);
                    
                    // Add scale
                    L.control.scale({
                        imperial: true,
                        metric: true
                    }).addTo(map);
                    
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 100);
                    
                } catch (error) {
                    console.error('Error initializing map:', error);
                    return false;
                }
            }
            
            return true;
        }
        
        function addTrailToMap(coordinates) {
            // Remove old polyline if exists
            if (userTrackPolyline) {
                map.removeLayer(userTrackPolyline);
            }
            
            // Clear existing markers
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });
            
            // Add user track polyline
            userTrackPolyline = L.polyline(coordinates, {
                color: '#10b981',
                weight: 4,
                opacity: 0.8
            }).addTo(map);
            
            userTrackPolyline.bindPopup('Your GPS Track');
            
            // Add start marker
            const startIcon = L.divIcon({
                html: '<div style="background: #10b981; color: white; padding: 5px; border-radius: 50%; font-weight: bold; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">S</div>',
                iconSize: [30, 30],
                className: 'custom-div-icon'
            });
            
            L.marker(coordinates[0], {
                title: 'Start',
                icon: startIcon
            }).addTo(map).bindPopup('Start Point');
            
            // Add end marker
            const endIcon = L.divIcon({
                html: '<div style="background: #dc2626; color: white; padding: 5px; border-radius: 50%; font-weight: bold; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">E</div>',
                iconSize: [30, 30],
                className: 'custom-div-icon'
            });
            
            L.marker(coordinates[coordinates.length - 1], {
                title: 'End',
                icon: endIcon
            }).addTo(map).bindPopup('End Point');
            
            // Fit map to trail
            setTimeout(() => {
                map.fitBounds(userTrackPolyline.getBounds(), {
                    padding: [50, 50],
                    animate: true
                });
                
                setTimeout(() => {
                    map.invalidateSize();
                }, 300);
            }, 100);
        }
        
        async function processCSV(results) {
            const data = results.data;
            currentCoordinates = [];
            currentElevations = [];
            let totalDistance = 0;
            let elevationGain = 0;
            let elevationLoss = 0;
            const distances = [0];
            
            // Process data
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                const lat = parseFloat(row['Latitude'] || row['latitude'] || row[0]);
                const lon = parseFloat(row['Longitude'] || row['longitude'] || row[1]);
                const ele = parseFloat(row['Elevation'] || row['elevation'] || row[2]);
                
                if (!isNaN(lat) && !isNaN(lon)) {
                    currentCoordinates.push([lat, lon]);
                    currentElevations.push(ele);
                    
                    if (i > 0) {
                        const dist = calculateDistance(
                            currentCoordinates[i-1][0], currentCoordinates[i-1][1],
                            lat, lon
                        );
                        totalDistance += dist;
                        distances.push(totalDistance);
                        
                        const elevChange = ele - currentElevations[i-1];
                        if (elevChange > 0) {
                            elevationGain += elevChange;
                        } else {
                            elevationLoss += Math.abs(elevChange);
                        }
                    }
                }
            }
            
            // Calculate average grade
            const avgGrade = totalDistance > 0 ? 
                ((elevationGain - elevationLoss) / (totalDistance * 5280) * 100).toFixed(1) : 0;
            
            // Update all statistics
            document.getElementById('totalDistance').textContent = totalDistance.toFixed(2);
            document.getElementById('quickDistance').textContent = totalDistance.toFixed(2);
            document.getElementById('elevationGain').textContent = Math.round(elevationGain);
            document.getElementById('quickElevGain').textContent = Math.round(elevationGain);
            document.getElementById('elevationLoss').textContent = Math.round(elevationLoss);
            document.getElementById('netElevation').textContent = 
                Math.round(currentElevations[currentElevations.length - 1] - currentElevations[0]);
            document.getElementById('maxElevation').textContent = Math.round(Math.max(...currentElevations));
            document.getElementById('quickMaxElev').textContent = Math.round(Math.max(...currentElevations));
            document.getElementById('minElevation').textContent = Math.round(Math.min(...currentElevations));
            document.getElementById('avgGrade').textContent = avgGrade;
            
            // Show results
            document.getElementById('results').classList.remove('hidden');
            
            // Initialize map
            setTimeout(() => {
                if (initializeMap(currentCoordinates)) {
                    addTrailToMap(currentCoordinates);
                    
                    // Query for nearby trails
                    queryNearbyTrails(currentCoordinates).then(trails => {
                        console.log('Found trails:', trails);
                        displayNearbyTrails(trails);
                        
                        // Find best match
                        const match = findBestTrailMatch(currentCoordinates, trails);
                        displayTrailMatch(match);
                    });
                    
                    // Update trail conditions (mock for now)
                    document.getElementById('trailConditions').innerHTML = `
                        <div style="color: #065f46;">
                            <strong>Current Conditions:</strong><br>
                            üå§Ô∏è Clear and dry<br>
                            üå°Ô∏è Temperature: 72¬∞F<br>
                            üí® Wind: 5 mph<br>
                            <small style="color: #718096;">Last updated: Today</small>
                        </div>
                    `;
                }
            }, 100);
            
            // Create elevation chart
            const ctx = document.getElementById('elevationChart').getContext('2d');
            
            if (elevationChart) {
                elevationChart.destroy();
            }
            
            const sampleRate = Math.max(1, Math.floor(distances.length / 500));
            const sampledDistances = distances.filter((_, i) => i % sampleRate === 0);
            const sampledElevations = currentElevations.filter((_, i) => i % sampleRate === 0);
            
            elevationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sampledDistances.map(d => d.toFixed(2)),
                    datasets: [{
                        label: 'Elevation (ft)',
                        data: sampledElevations,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Elevation Profile',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Distance (miles)'
                            },
                            ticks: {
                                callback: function(value, index) {
                                    return index % Math.floor(sampledDistances.length / 10) === 0 ? 
                                           parseFloat(this.getLabelForValue(value)).toFixed(1) : '';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Elevation (feet)'
                            }
                        }
                    }
                }
            });
        }
        
        // Window resize handler
        window.addEventListener('resize', () => {
            if (map) {
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
        });
        
        // File input handler
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileLabel').textContent = `Selected: ${file.name}`;
                document.getElementById('fileLabel').classList.add('has-file');
                
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    complete: processCSV,
                    error: function(error) {
                        alert('Error parsing CSV: ' + error.message);
                    }
                });
            }
        });
        
        // Drag and drop support
        const fileLabel = document.getElementById('fileLabel');
        const fileInput = document.getElementById('csvFile');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileLabel.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            fileLabel.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            fileLabel.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight(e) {
            fileLabel.style.borderColor = '#10b981';
            fileLabel.style.background = '#f0fdf4';
        }
        
        function unhighlight(e) {
            fileLabel.style.borderColor = '#cbd5e0';
            fileLabel.style.background = 'white';
        }
        
        fileLabel.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            fileInput.files = files;
            const event = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(event);
        }
    </script>
</body>
</html>